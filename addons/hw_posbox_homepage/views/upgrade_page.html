{% extends "layout.html" %}
{% from "loading.html" import loading_block_ui %}
{% block head %}
    <script type="text/javascript" src="/web/static/lib/jquery/jquery.js"></script>
    <script>
        $(function(){
            var upgrading = false;
            $('#upgrade').click(function(){
                if(!upgrading){
                    upgrading = true;
                    $('.loading-block').removeClass('o_hide');
                    $.ajax({
                        url:'/hw_proxy/perform_upgrade/'
                    }).done(function(status){
                        $('.message-title').text('Upgrade successful');
                        var cpt = 110;
                        setInterval(function(){
                            --cpt;
                            if(cpt==0){location.reload();}
                            $('.message-status').text('Restarting the IoTBox.  Available in ' + cpt);
                        } , 1000);
                    }).fail(function(){
                        $('.error-message').text('Upgrade Failed');
                    });
                }
            });
            $('#flash').click(function(){
                if ( confirm('Alert message to flash IoT Box to ' ) ) {
                    $('.loading-block').removeClass('o_hide');
                    var messageStatus = $('.message-status');
                    var messageError = $('.error-message');
                    $('.message-title').text('IoTBox perform a self flashing it take a lot of time (~25min).');
                    messageStatus.text('Prepare space for IoTBox.');
                    console.log('Prepare space for IoTBox.');
                    console.log(messageStatus);
                    $.ajax({
                        url:'/hw_proxy/perform_flashing_create_partition/'
                    }).done(function(status){
                        messageStatus.text('Prepare new boot partition.');
                        console.log('Prepare new boot partition.');
                        console.log(messageStatus);
                        console.log(status);
                        $.ajax({
                            url:'/hw_proxy/perform_flashing_download_raspbian/'
                        }).done(function(status){
                            messageStatus.text('Install new boot partition.');
                            console.log('Install new boot partition.');
                            console.log(messageStatus);
                            console.log(status);
                            $.ajax({
                                url:'/hw_proxy/perform_flashing_copy_raspbian/'
                            }).always(function(){
                                messageStatus.text('Prepare to restart and installation of the new version of the IoT Box');
                                setTimeout(function() {
                                    messageStatus.text('The auto flash is almost finished - the page will be automatically reloaded');
                                    setInterval(function(){
                                        console.log('Ping box.');
                                        $.ajax({
                                            url: '/hw_proxy/get_version',
                                            timeout: 4000,
                                        }).done(function(version) {
                                            console.log(version);
                                            if (version == {{ flashToVersion }}) {
                                                window.location = '/';
                                            }
                                        });
                                    } , 2000);
                                }, 240000);
                            });
                        }).fail(function(){
                            messageError.text('Download raspbian failed');
                        });
                    }).fail(function(){
                        messageError.text('Creating partition failed');
                    });
                }
            });
        });
    </script>
    <style>
        .commit-details {
            background: #f1f1f1;
            padding: 10px 10px 0 10px;
            border-radius: 5px;
        }
    </style>
{% endblock %}
{% block content %}
    <h2 class="text-center">IoT Box Software Upgrade</h2>
    <p>
        This tool will help you perform an upgrade of the IoTBox's software over the internet.
        However the preferred method to upgrade the IoTBox is to flash the sd-card with
        the <a href='http://nightly.odoo.com/master/posbox/iotbox/iotbox-latest.zip'>latest image</a>. The upgrade
        procedure is explained into to the
        <a href='https://www.odoo.com/documentation/user/13.0/iot.html'>IoTBox manual</a>
    </p>
    <p>
        To upgrade the IoTBox, click on the upgrade button. The upgrade will take a few minutes. <b>Do not reboot</b> the IoTBox during the upgrade.
    </p>
    <div class="commit-details">
        <div style="padding-bottom: 5px; font-weight: bold;">
            Latest patch:
        </div>
        <pre style="margin: 0;padding: 15px 0; overflow: auto;">{{ commit|safe }}</pre>
    </div>
    <div class="text-center" style="margin: 15px auto;">
        <a class="btn" href='#' id='upgrade'>Upgrade</a>
        {% if flashToVersion %}
            <a class="btn" href='#' id='flash'>Flash to {{ flashToVersion }} !</a>
        {% endif %}
    </div>
    {{ loading_block_ui(loading_message) }}
{% endblock %}
